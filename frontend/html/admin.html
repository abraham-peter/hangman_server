<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard - FastAPI Project</title>
    <link rel="stylesheet" href="styles.css">
</head>
<body class="single-column">
    <div class="container admin-container">
        <div class="admin-header">
            <div style="display: flex; align-items: center; gap: 1rem;">
                <img src="assets/fastapi-logo.svg" alt="Logo" style="height: 32px; width: auto;">
                <h1 style="font-size: 1.25rem;">Dashboard</h1>
            </div>
        </div>

        <div id="loading">Loading...</div>
        
        <div id="content" class="hidden">
            <h2 style="font-size: 1.5rem; margin-bottom: 1.5rem;">Welcome, <span id="user-name">User</span>!</h2>
            
            <div class="info-grid">
                <div class="info-card">
                    <div class="info-label">Email Address</div>
                    <div class="info-value" id="user-email"></div>
                </div>
                
                <div class="info-card">
                    <div class="info-label">User ID</div>
                    <div class="info-value" id="user-id" style="font-family: monospace; font-size: 0.875rem;"></div>
                </div>
                
                <div class="info-card">
                    <div class="info-label">Role</div>
                    <div class="info-value" id="user-role">User</div>
                </div>
            </div>
            
            <hr style="margin: 2rem 0; border: 0; border-top: 1px solid var(--border);">
            
            <!-- Leaderboard Section -->
            <h3 style="margin-bottom: 1rem;">üèÜ Leaderboard</h3>
            <div id="leaderboard-container" style="margin-bottom: 2rem;">
                <div id="leaderboard-loading">Loading leaderboard...</div>
                <div id="leaderboard-content" style="display: none;">
                    <table style="width: 100%; border-collapse: collapse; margin-top: 1rem;">
                        <thead>
                            <tr style="background-color: var(--muted); text-align: left;">
                                <th style="padding: 0.75rem; border: 1px solid var(--border);">Rank</th>
                                <th style="padding: 0.75rem; border: 1px solid var(--border);">Username</th>
                                <th style="padding: 0.75rem; border: 1px solid var(--border);">Games</th>
                                <th style="padding: 0.75rem; border: 1px solid var(--border);">Wins</th>
                                <th style="padding: 0.75rem; border: 1px solid var(--border);">Win Rate</th>
                                <th style="padding: 0.75rem; border: 1px solid var(--border);">Score</th>
                            </tr>
                        </thead>
                        <tbody id="leaderboard-body">
                        </tbody>
                    </table>
                </div>
                <div id="leaderboard-error" class="error hidden"></div>
            </div>

            <hr style="margin: 2rem 0; border: 0; border-top: 1px solid var(--border);">

            <!-- User History Section -->
            <h3 style="margin-bottom: 1rem;">üìú My Game History</h3>
            <div id="history-container" style="margin-bottom: 2rem;">
                <div id="history-loading">Loading history...</div>
                <div id="history-content" style="display: none;">
                    <table style="width: 100%; border-collapse: collapse; margin-top: 1rem;">
                        <thead>
                            <tr style="background-color: var(--muted); text-align: left;">
                                <th style="padding: 0.75rem; border: 1px solid var(--border);">Date</th>
                                <th style="padding: 0.75rem; border: 1px solid var(--border);">Word</th>
                                <th style="padding: 0.75rem; border: 1px solid var(--border);">Status</th>
                                <th style="padding: 0.75rem; border: 1px solid var(--border);">Guesses</th>
                                <th style="padding: 0.75rem; border: 1px solid var(--border);">Wrong Letters</th>
                            </tr>
                        </thead>
                        <tbody id="history-body">
                        </tbody>
                    </table>
                </div>
                <div id="history-error" class="error hidden"></div>
            </div>
            
            <hr style="margin: 2rem 0; border: 0; border-top: 1px solid var(--border);">
            
            <h3 style="margin-bottom: 1rem;">Actions</h3>
            <p style="color: var(--muted-foreground); margin-bottom: 1.5rem;">Manage your account settings.</p>
            
            <div style="display: flex; gap: 1rem;">
                <!-- <button class="primary" style="width: auto;">Edit Profile</button> -->
                <button onclick="logout()" class="destructive" style="width: auto; padding: 0 2rem;">Log Out</button>
            </div>
        </div>
    </div>

    <script src="app.js"></script>
    <script>
    (async function(){
        try {
            const user = await getCurrentUser();

            document.getElementById('user-name').textContent = user.full_name || 'User';
            document.getElementById('user-email').textContent = user.email;
            document.getElementById('user-id').textContent = user.user_id;
            document.getElementById('user-role').textContent = user.is_admin ? 'Admin' : 'User';

            document.getElementById('loading').classList.add('hidden');
            document.getElementById('content').classList.remove('hidden');

            // Load leaderboard
            loadLeaderboard();
            
            // Load user history (games from user's sessions)
            loadUserHistory(user.user_id);

        } catch (err) {
            // Not authenticated ‚Äî go to login
            window.location.href = 'login.html';
        }

        const apiLogout = window.logout;
        window.logout = async function() {
            try { await apiLogout(); } catch (e) {}
            window.location.href = 'index.html';
        }
    })();

    async function loadLeaderboard() {
        try {
            const leaderboard = await apiRequest('/stats/leaderboard?limit=10', 'GET');
            
            const tbody = document.getElementById('leaderboard-body');
            tbody.innerHTML = '';
            
            if (leaderboard && leaderboard.length > 0) {
                leaderboard.forEach((entry, index) => {
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td style="padding: 0.75rem; border: 1px solid var(--border);">${index + 1}</td>
                        <td style="padding: 0.75rem; border: 1px solid var(--border);">${entry.username}</td>
                        <td style="padding: 0.75rem; border: 1px solid var(--border);">${entry.games}</td>
                        <td style="padding: 0.75rem; border: 1px solid var(--border);">${entry.wins}</td>
                        <td style="padding: 0.75rem; border: 1px solid var(--border);">${(entry.win_rate * 100).toFixed(1)}%</td>
                        <td style="padding: 0.75rem; border: 1px solid var(--border);">${entry.score ? entry.score.toFixed(2) : 'N/A'}</td>
                    `;
                    tbody.appendChild(row);
                });
                
                document.getElementById('leaderboard-loading').style.display = 'none';
                document.getElementById('leaderboard-content').style.display = 'block';
            } else {
                document.getElementById('leaderboard-loading').textContent = 'No leaderboard data available yet.';
            }
        } catch (err) {
            document.getElementById('leaderboard-loading').style.display = 'none';
            const errorDiv = document.getElementById('leaderboard-error');
            errorDiv.textContent = 'Failed to load leaderboard: ' + err.message;
            errorDiv.classList.remove('hidden');
        }
    }

    async function loadUserHistory(userId) {
        try {
            // First get user's sessions
            const sessions = await apiRequest(`/sessions?user_id=${userId}`, 'GET');
            
            let allGames = [];
            
            // For each session, get games
            if (sessions && sessions.length > 0) {
                for (const session of sessions) {
                    try {
                        const games = await apiRequest(`/sessions/${session.session_id}/games`, 'GET');
                        if (games && games.length > 0) {
                            allGames = allGames.concat(games);
                        }
                    } catch (e) {
                        console.error('Error loading games for session:', session.session_id, e);
                    }
                }
            }
            
            const tbody = document.getElementById('history-body');
            tbody.innerHTML = '';
            
            if (allGames.length > 0) {
                // Sort by date (newest first)
                allGames.sort((a, b) => new Date(b.created_at) - new Date(a.created_at));
                
                // Show last 20 games
                allGames.slice(0, 20).forEach(game => {
                    const row = document.createElement('tr');
                    const date = new Date(game.created_at).toLocaleDateString();
                    const statusColor = game.status === 'WON' ? 'green' : game.status === 'LOST' ? 'red' : 'orange';
                    
                    row.innerHTML = `
                        <td style="padding: 0.75rem; border: 1px solid var(--border);">${date}</td>
                        <td style="padding: 0.75rem; border: 1px solid var(--border);">${game.word || 'N/A'}</td>
                        <td style="padding: 0.75rem; border: 1px solid var(--border); color: ${statusColor}; font-weight: bold;">${game.status}</td>
                        <td style="padding: 0.75rem; border: 1px solid var(--border);">${game.total_guesses || 0}</td>
                        <td style="padding: 0.75rem; border: 1px solid var(--border);">${game.wrong_letters ? game.wrong_letters.join(', ') : ''}</td>
                    `;
                    tbody.appendChild(row);
                });
                
                document.getElementById('history-loading').style.display = 'none';
                document.getElementById('history-content').style.display = 'block';
            } else {
                document.getElementById('history-loading').textContent = 'No game history available yet. Start playing!';
            }
        } catch (err) {
            document.getElementById('history-loading').style.display = 'none';
            const errorDiv = document.getElementById('history-error');
            errorDiv.textContent = 'Failed to load history: ' + err.message;
            errorDiv.classList.remove('hidden');
        }
    }
    </script>
</body>
</html>
